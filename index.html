<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sri Lankan Community Welfare</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Add Supabase JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        /* [your CSS here, unchanged for brevity] */
        /* ... (everything inside your <style> stays the same) ... */
    </style>
</head>
<body>
    <!-- [your HTML markup, unchanged for brevity] -->
    <!-- ... (everything inside your <body> stays the same) ... -->

    <script>
        // === SUPABASE CONFIGURATION ===
        // Replace with your own details!
        const SUPABASE_URL = 'https://your-project-id.supabase.co';
        const SUPABASE_ANON_KEY = 'your-anon-key';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const monthlyContributionUSD = 15;
        let exchangeRateLKR = 300.67;
        let members = [];

        // === SUPABASE DATA FUNCTIONS ===

        // Load all members from Supabase
        async function loadMembersFromAPI() {
            try {
                const { data, error } = await supabase
                    .from('members')
                    .select('*');
                if (error) throw error;
                members = data || [];
                updateDisplay();
            } catch (error) {
                console.error("Failed to load members from Supabase:", error);
                alert("Could not load data from Supabase. Check your setup.");
            }
        }

        // Add a new member or update existing
        async function saveMemberToSupabase(memberId, memberData) {
            try {
                let result;
                if (memberId) {
                    // Update
                    const { data, error } = await supabase
                        .from('members')
                        .update(memberData)
                        .eq('id', memberId)
                        .select();
                    if (error) throw error;
                    result = data;
                } else {
                    // Insert
                    const { data, error } = await supabase
                        .from('members')
                        .insert([memberData])
                        .select();
                    if (error) throw error;
                    result = data;
                }
                return result;
            } catch (error) {
                throw error;
            }
        }

        // === (optional) Export/Import can be implemented if you want using Supabase Storage or local JSON download ===

        // --- UTILITY FUNCTIONS ---
        function calculateAge(dateString) {
            if (!dateString) return null;
            const birthDate = new Date(dateString);
            const today = new Date();
            let years = today.getFullYear() - birthDate.getFullYear();
            let months = today.getMonth() - birthDate.getMonth();
            let days = today.getDate() - birthDate.getDate();
            if (days < 0) { months--; days += new Date(today.getFullYear(), today.getMonth(), 0).getDate(); }
            if (months < 0) { years--; months += 12; }
            return { years, months, days, full: `${years} years, ${months} months, ${days} days` };
        }

        function formatShortDate(date) {
            return date ? new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
        }

        function formatDualCurrency(amountInUSD) {
            const amountLKR = amountInUSD * exchangeRateLKR;
            const usdString = `$${amountInUSD.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            const lkrString = `Rs ${amountLKR.toLocaleString('en-LK', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            return `${usdString}<br><span class="secondary-currency">(${lkrString})</span>`;
        }

        async function updateExchangeRate() {
            try {
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const data = await response.json();
                if (data && data.rates && data.rates.LKR) {
                    exchangeRateLKR = data.rates.LKR;
                }
            } catch (error) {
                console.error("Could not fetch live exchange rate. Using default.", error);
            }
        }

        // --- LOGIN & DASHBOARD SETUP ---
        document.addEventListener('DOMContentLoaded', () => {
            const loginModal = document.getElementById('loginModalOverlay');
            const loginBtn = document.getElementById('loginBtn');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const loginError = document.getElementById('loginError');

            document.body.classList.add('modal-open');
            loginModal.classList.add('is-visible');

            const attemptLogin = () => {
                if (usernameInput.value === 'admin' && passwordInput.value === 'admin') {
                    loginModal.classList.remove('is-visible');
                    document.body.classList.remove('modal-open');
                    initializeDashboard();
                } else {
                    loginError.textContent = 'Invalid username or password.';
                    setTimeout(() => { loginError.textContent = ''; }, 3000);
                }
            };

            loginBtn.addEventListener('click', attemptLogin);
            passwordInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') attemptLogin(); });
            usernameInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') attemptLogin(); });
        });

        async function initializeDashboard() {
            await updateExchangeRate();
            await loadMembersFromAPI();
            setupEventListeners();
        }

        // --- HANDLE MEMBER FORM SUBMISSION ---
        async function handleFormSubmit(e) {
            e.preventDefault();
            const memberId = document.getElementById('member-id').value;
            const paidMonths = [];
            document.querySelectorAll('#payments-grid input:checked').forEach(cb => {
                paidMonths.push(cb.value);
            });

            const memberData = {
                name: document.getElementById('member-name').value,
                birthDate: document.getElementById('member-birthdate').value || null,
                paidMonths: paidMonths,
            };

            try {
                await saveMemberToSupabase(memberId, memberData);
                closeMemberModal();
                await loadMembersFromAPI();
                alert(`Member ${memberId ? 'updated' : 'added'} successfully!`);
            } catch (error) {
                console.error('Error saving member:', error);
                alert(`Error: ${error.message}`);
            }
        }

        // --- UI RENDERING & UPDATES ---
        function updateDisplay() {
            renderTable();
            updateAllStats();
        }

        function renderTable() {
            const tableBody = document.getElementById('contribution-table-body');
            tableBody.innerHTML = '';

            const sortedMembers = members.slice().sort((a, b) => {
                if (!a.birthDate) return 1;
                if (!b.birthDate) return -1;
                return new Date(b.birthDate) - new Date(a.birthDate);
            });

            sortedMembers.forEach((member, index) => {
                const age = calculateAge(member.birthDate);
                const totalPaidUSD = (member.paidMonths ? member.paidMonths.length : 0) * monthlyContributionUSD;
                const summaryRow = document.createElement('tr');
                summaryRow.className = 'summary-row member-row';
                summaryRow.setAttribute('data-member-id', member.id || '');
                summaryRow.innerHTML = `
                    <td><button class="expand-btn"><i class="fas fa-chevron-down"></i></button></td>
                    <td>${index + 1}</td>
                    <td class="name-cell">${member.name}</td>
                    <td>${member.birthDate ? formatShortDate(member.birthDate) : ''}</td>
                    <td>${age ? age.years : '-'}</td>
                    <td class="total-cell">${formatDualCurrency(totalPaidUSD)}</td>
                    <td>
                        <button class="btn-update" onclick="openMemberModal('${member.id || ''}')"><i class="fas fa-edit"></i> Edit</button>
                    </td>
                `;
                tableBody.appendChild(summaryRow);
            });

            // Update grand total
            const grandTotal = members.reduce((sum, m) => sum + (m.paidMonths ? m.paidMonths.length : 0) * monthlyContributionUSD, 0);
            document.getElementById('grand-total-paid').innerHTML = formatDualCurrency(grandTotal);
        }

        function updateAllStats() {
            document.getElementById('total-members-value').textContent = members.length;
            document.getElementById('active-contributors-value').textContent = members.filter(m => m.paidMonths && m.paidMonths.length > 0).length;
            const totalCollected = members.reduce((sum, m) => sum + (m.paidMonths ? m.paidMonths.length : 0) * monthlyContributionUSD, 0);
            document.getElementById('total-collected-value').innerHTML = formatDualCurrency(totalCollected);
            // ... More stat updates can go here
        }

        // --- MODAL & FORM HANDLING ---
        function openMemberModal(memberId = '') {
            const modal = document.getElementById('memberModal');
            document.getElementById('modalTitle').textContent = memberId ? 'Update Member' : 'Add Member';
            document.getElementById('member-id').value = memberId;
            document.getElementById('member-name').value = '';
            document.getElementById('member-birthdate').value = '';
            // You can also load paidMonths into payments-grid here
            modal.classList.add('is-visible');
        }

        function closeMemberModal() {
            document.getElementById('memberModal').classList.remove('is-visible');
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            document.getElementById('memberForm').addEventListener('submit', handleFormSubmit);
            document.querySelector('.close-modal-btn').addEventListener('click', closeMemberModal);
            document.getElementById('addMemberBtn').addEventListener('click', () => openMemberModal(''));
            // Add further listeners for refresh, export, import, etc if needed
        }
    </script>
</body>
</html>
